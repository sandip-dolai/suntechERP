{% extends 'base/base.html' %}
{% load static %}

{% block title %}BOM Report - Suntech ERP{% endblock %}

{% block content %}
<h2>Bill of Materials Report</h2>

<form method="get" class="mb-4">
    <div class="row g-3">
        <div class="col-md-4">
            <label class="form-label">PO Number</label>
            <input type="text" name="po_number" class="form-control" value="{{ filters.po_number }}" placeholder="PO-123">
        </div>
        <div class="col-md-4">
            <label class="form-label">Company</label>
            <select name="company" class="form-control select2">
                <option value="">All</option>
                {% for c in companies %}
                <option value="{{ c.id }}" {% if filters.company == c.id|stringformat:"s" %}selected{% endif %}>{{ c.code }} - {{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Item Code</label>
            <input type="text" name="item_code" class="form-control" value="{{ filters.item_code }}" placeholder="ITM001">
        </div>
        <div class="col-md-2">
            <label class="form-label">From Date</label>
            <input type="date" name="date_from" class="form-control" value="{{ filters.date_from }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">To Date</label>
            <input type="date" name="date_to" class="form-control" value="{{ filters.date_to }}">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
    </div>
</form>

{% if page_obj %}
<table class="table table-bordered table-hover">
    <thead class="table-success">
        <tr>
            <th>#</th>
            <th>PO Number</th>
            <th>Company</th>
            <th>Item Code</th>
            <th>Item Name</th>
            <th>Qty</th>
            <th>Unit</th>
            <th>PO Date</th>
            <th>Created By</th>
        </tr>
    </thead>
    <tbody>
        {% for bom in page_obj %}
        <tr>
            <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td>{{ bom.po.po_number }}</td>
            <td>{{ bom.po.company.name }}</td>
            <td>{{ bom.item.code }}</td>
            <td>{{ bom.item.name }}</td>
            <td class="text-end">{{ bom.quantity }}</td>
            <td>{{ bom.unit|default:"—" }}</td>
            <td>{{ bom.po.po_date|date:"d M Y" }}</td>
            <td>{{ bom.creator_name|default:"—" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="9" class="text-center text-muted">No BOMs found.</td></tr>
        {% endfor %}
    </tbody>
</table>

<!-- PAGINATION – preserves all filters -->
{% with query=request.GET.urlencode %}
<div class="d-flex justify-content-between mt-3">
    <div>
        {% if page_obj.has_previous %}
            <a href="?page=1{% if query %}&{{ query }}{% endif %}" class="btn btn-sm btn-outline-primary">First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if query %}&{{ query }}{% endif %}" class="btn btn-sm btn-outline-primary">Previous</a>
        {% else %}
            <span class="btn btn-sm btn-secondary disabled">First</span>
            <span class="btn btn-sm btn-secondary disabled">Previous</span>
        {% endif %}
    </div>
    <div class="align-self-center text-muted">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }} ({{ page_obj.paginator.count }} items)
    </div>
    <div>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if query %}&{{ query }}{% endif %}" class="btn btn-sm btn-outline-primary">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&{{ query }}{% endif %}" class="btn btn-sm btn-outline-primary">Last</a>
        {% else %}
            <span class="btn btn-sm btn-secondary disabled">Next</span>
            <span class="btn btn-sm btn-secondary disabled">Last</span>
        {% endif %}
    </div>
</div>
{% endwith %}

{% else %}
<div class="alert alert-info">No BOMs match the filters.</div>
{% endif %}
{% endblock %}