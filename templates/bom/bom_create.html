{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-6">
            <h4>Create BOM</h4>
        </div>
        <div class="col-md-6 text-end">
            <a href="{% url 'bom:bom_list' %}" class="btn btn-secondary">
                Back
            </a>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}

        <!-- ========================= -->
        <!-- BOM HEADER -->
        <!-- ========================= -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">

                    <div class="col-md-4">
                        <label class="form-label">Purchase Order</label>
                        <select
                            name="purchase_order"
                            id="id_purchase_order"
                            class="form-control"
                            required
                        >
                            <option value="">---------</option>
                            {% for po in purchase_orders %}
                                <option value="{{ po.id }}">
                                    {{ po.po_number }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">BOM Date</label>
                        <input
                            type="date"
                            name="bom_date"
                            class="form-control"
                            required
                        >
                    </div>

                </div>
            </div>
        </div>

        <!-- ========================= -->
        <!-- BOM ITEMS -->
        <!-- ========================= -->
        <div class="card">
            <div class="card-body">
                <h6 class="mb-3">BOM Items</h6>

                <div class="table-responsive">
                    <table class="table table-bordered" id="bom-items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>PO Qty</th>
                                <th>UOM</th>
                                <th>BOM Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    Select a PO to load items
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========================= -->
        <!-- ACTIONS -->
        <!-- ========================= -->
        <div class="mt-3 text-end">
            <button type="submit" class="btn btn-primary">
                Save BOM
            </button>
        </div>

    </form>
</div>

<!-- ========================= -->
<!-- JS -->
<!-- ========================= -->
<script>
let poItemsCache = [];

$("#id_purchase_order").on("change", function () {
    let poId = $(this).val();
    let tbody = $("#bom-items-table tbody");

    tbody.html("");

    if (!poId) {
        tbody.append(`
            <tr>
                <td colspan="4" class="text-center text-muted">
                    Select a PO to load items
                </td>
            </tr>
        `);
        return;
    }

    $.ajax({
        url: "{% url 'bom:ajax_load_po_items' %}",
        data: { po_id: poId },
        success: function (data) {
            poItemsCache = data;

            if (data.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="4" class="text-center text-danger">
                            No items found for this PO
                        </td>
                    </tr>
                `);
                return;
            }

            data.forEach(function (item) {
                tbody.append(`
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.uom}</td>
                        <td>
                            <input
                                type="number"
                                step="0.01"
                                name="quantity_${item.id}"
                                class="form-control"
                                value="${item.quantity}"
                                required
                            >
                        </td>
                    </tr>
                `);
            });
        }
    });
});
</script>

{% endblock %}
