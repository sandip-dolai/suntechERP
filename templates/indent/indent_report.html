{% extends 'base/base.html' %}
{% load static %}

{% block title %}Indent Report - Suntech ERP{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <h2 class="mb-4">Indent Report</h2>

  <!-- Filters Form -->
  <form method="get" class="mb-4">
    <div class="row g-3">
      <div class="col-md-4 col-lg-3">
        <label class="form-label">Indent #</label>
        <input type="text" name="indent_number" class="form-control" value="{{ filters.indent_number }}" placeholder="IND-001">
      </div>
      <div class="col-md-4 col-lg-3">
        <label class="form-label">PO Number</label>
        <input type="text" name="po_number" class="form-control" value="{{ filters.po_number }}" placeholder="PO-123">
      </div>
      <div class="col-md-4 col-lg-3">
        <label class="form-label">Company</label>
        <select name="company" class="form-control select2">
          <option value="">All</option>
          {% for c in companies %}
          <option value="{{ c.id }}" {% if filters.company == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.code }} - {{ c.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 col-lg-3">
        <label class="form-label">Item Code</label>
        <input type="text" name="item_code" class="form-control" value="{{ filters.item_code }}" placeholder="ITM001">
      </div>
      <div class="col-md-4 col-lg-2">
        <label class="form-label">Status</label>
        <select name="status" class="form-control">
          <option value="">All</option>
          {% for val, label in statuses %}
          <option value="{{ val }}" {% if filters.status == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 col-lg-2">
        <label class="form-label">From Date</label>
        <input type="date" name="date_from" class="form-control" value="{{ filters.date_from }}">
      </div>
      <div class="col-md-4 col-lg-2">
        <label class="form-label">To Date</label>
        <input type="date" name="date_to" class="form-control" value="{{ filters.date_to }}">
      </div>
      <div class="col-md-4 col-lg-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
    </div>
  </form>

  <!-- Results Table -->
  {% if page_obj %}
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-success">
        <tr>
          <th scope="col">#</th>
          <th scope="col">Indent #</th>
          <th scope="col">PO #</th>
          <th scope="col">Company</th>
          <th scope="col">Item Code</th>
          <th scope="col">Item Name</th>
          <th scope="col" class="text-end">Qty</th>
          <th scope="col">Unit</th>
          <th scope="col">Indent Date</th>
          <th scope="col">Required Date</th>
          <th scope="col">Status</th>
          <th scope="col">Created By</th>
        </tr>
      </thead>
      <tbody>
        {% for i in page_obj %}
        <tr>
          <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td>
            <a href="{% url 'indent:indent_edit' i.pk %}" class="text-decoration-none fw-medium">
              {{ i.indent_number }}
            </a>
          </td>
          <td>{{ i.po_number|default:"—" }}</td>
          <td>{{ i.company_name|default:"—" }}</td>
          <td>{{ i.item_code }}</td>
          <td>{{ i.item_name }}</td>
          <td class="text-end">{{ i.bom.quantity }}</td>
          <td>{{ i.bom.unit|default:"—" }}</td>
          <td>{{ i.indent_date|date:"d M Y" }}</td>
          <td>{{ i.required_date|date:"d M Y"|default:"—" }}</td>
          <td>
            <span class="badge rounded-pill bg-{{ i.status|lower }} text-dark">
              {{ i.get_status_display }}
            </span>
          </td>
          <td>{{ i.creator_name|default:"—" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="12" class="text-center text-muted py-4">No indents found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PAGINATION – preserves all filters -->
  {% with query=request.GET.urlencode %}
  <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
    <div>
      {% if page_obj.has_previous %}
      <a href="?page=1{% if query %}&{{ query }}{% endif %}" class="btn btn-sm btn-outline-primary">First</a>
      <a href="?page={{ page_obj.previous_page_number }}{% if query %}&{{ query }}{% endif %}" class="btn btn-sm btn-outline-primary">Previous</a>
      {% else %}
      <span class="btn btn-sm btn-secondary disabled">First</span>
      <span class="btn btn-sm btn-secondary disabled">Previous</span>
      {% endif %}
    </div>

    <div class="text-muted small">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }} 
      ({{ page_obj.paginator.count }} indent{{ page_obj.paginator.count|pluralize }})
    </div>

    <div>
      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if query %}&{{ query }}{% endif %}" class="btn btn-sm btn-outline-primary">Next</a>
      <a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&{{ query }}{% endif %}" class="btn btn-sm btn-outline-primary">Last</a>
      {% else %}
      <span class="btn btn-sm btn-secondary disabled">Next</span>
      <span class="btn btn-sm btn-secondary disabled">Last</span>
      {% endif %}
    </div>
  </div>
  {% endwith %}

  {% else %}
  <div class="alert alert-info text-center py-4">
    <i class="bi bi-inbox"></i> No indents match the selected filters.
  </div>
  {% endif %}

  <!-- Back Button -->
  <div class="mt-3">
    <a href="{% url 'indent:indent_list' %}" class="btn btn-outline-secondary btn-sm">
      Back to Indent List
    </a>
  </div>
</div>

<!-- Optional: Bootstrap Icons (if not in base) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
  .badge {
    font-size: 0.75rem;
  }
  .table th, .table td {
    vertical-align: middle;
  }
  @media (max-width: 768px) {
    .table thead {
      font-size: 0.85rem;
    }
    .btn-sm {
      font-size: 0.8rem;
    }
  }
</style>
{% endblock %}