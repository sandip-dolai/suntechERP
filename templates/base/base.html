{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% block title %}
        Suntech ERP
      {% endblock %}
    </title>

    {% include 'partials/header_links.html' %}

    <style>
      .cursor-pointer {
        cursor: pointer;
      }
      .nav-2-level li.active > a {
        background-color: #ccccccff;
        color: #333;
      }
      * {
        margin: 0;
        padding: 0;
      }
    </style>

    {% block extra_css %}

    {% endblock %}
  </head>
  <body class="fixed-navbar">
    <div class="page-wrapper">
      {% include 'partials/header.html' %}
      {% include 'partials/navbar.html' %}
      <div class="content-wrapper mt-4">
        <div class="page-content fade-in-up">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
          {% endif %}

          {% block content %}

          {% endblock %}
        </div>
        {% include 'partials/footer.html' %}
      </div>
    </div>
    {% include 'partials/footer_links.html' %}
    {% block extra_js %}

    {% endblock %}
    <script>
      function confirmLogout(event) {
        event.preventDefault()
        const confirmed = confirm('Are you sure you want to logout?')
        if (confirmed) {
          document.getElementById('logout-form').submit()
        }
      }
    </script>
<script>
(function () {

  console.log("ðŸ”” Notification system initialized");

  function fetchNotifications() {

    const badge = document.getElementById("notification-badge");
    const list  = document.getElementById("notification-list");

    if (!badge || !list) {
      console.warn("ðŸ”” Notification DOM not found");
      return;
    }

    fetch("/notifications/unread/", {
      method: "GET",
      credentials: "same-origin",
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("HTTP " + response.status);
      }
      return response.json();
    })
    .then(data => {

      /* ðŸ”´ BADGE */
      if (data.count > 0) {
        badge.style.display = "inline-block";
        badge.textContent = data.count;
      } else {
        badge.style.display = "none";
        badge.textContent = "";
      }

      /* ðŸ“œ DROPDOWN LIST */
      let html = "";

      if (data.notifications.length > 0) {
        data.notifications.forEach(n => {
          html += `
            <li class="dropdown-item font-weight-bold">
              <a href="${n.url}">
                ${n.message}<br>
                <small class="text-muted">${n.created}</small>
              </a>
            </li>
          `;
        });
      } else {
        html = `
          <li class="dropdown-item text-muted">
            No notifications
          </li>
        `;
      }

      html += `
        <li class="dropdown-divider"></li>
        <li class="text-center">
          <a href="/notifications/">View all notifications</a>
        </li>
      `;

      list.innerHTML = html;
    })
    .catch(error => {
      console.error("ðŸ”” Notification fetch failed:", error);
    });
  }

  /* ðŸš€ START POLLING */
  document.addEventListener("DOMContentLoaded", function () {
    fetchNotifications();
    setInterval(fetchNotifications, 10000);
  });

})();
</script>

  </body>
</html>
